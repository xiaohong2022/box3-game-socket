/*!
 * GameSocket.js v1.0.1
 * Copyright (c) 2023 by 小宏XeLa
 * Licensed under MIT
 */
!function(f,e){"undefined"!==typeof module?module.exports=e():(f||globalThis).GameSocket=e()}(this,function(){var f=f||{};f.scope={};f.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};f.arrayIterator=function(a){return{next:f.arrayIteratorImpl(a)}};f.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if(b)return b.call(a);if("number"==typeof a.length)return f.arrayIterator(a);throw Error(String(a)+" is not an iterable or ArrayLike");};var e=Error("GameSocket runtime requires GameStorage.");if(!GameStorage)throw e;var n=storage;if(!n)throw e;var p=n.getGroupStorage;e=function(a){var b=this;this.readyState=0;this._db=p("GAMESOCKET_DBNAME_"+a);this._processed=[];this._closed=!1;this._callback=[];var h=Date.now(),k=function(){b._db.list({pageSize:1E4,cursor:0}).then(function(g){if(2==b.readyState)b.readyState=3;else{if(0==b.readyState){b.readyState=1;for(var c=f.makeIterator(b._callback.filter(function(m){return"open"==m.name})),d=c.next();!d.done;d=c.next())d.value.callback({startTimestamp:Number(h),endTimestamp:Number(Date.now())})}d=g.getCurrentPage();g=f.makeIterator(d);for(d=g.next();!d.done;d=g.next())if(c=d.value,!1===b._processed.includes(c.key)){b._processed.push(c.key);var l=f.makeIterator(b._callback.filter(function(m){return"message"==m.name}));for(d=l.next();!d.done;d=l.next())d.value.callback({data:c.value,sendTimestamp:Number(c.key),acceptTimestamp:Number(Date.now())})}setTimeout(function(){k()},16)}},function(g){b.readyState=2;var c=function(){if(3==b.readyState)for(var d=f.makeIterator(b._callback.filter(function(m){return"close"==m.name})),l=d.next();!l.done;l=d.next())l.value.callback({error:g,timestamp:Number(Date.now())});else setTimeout(c,16)};c()})};k()};e.prototype._event=function(a,b){var h={name:a,callback:b};this._callback.push(h);return{cancel:function(){h.name="";h.callback=function(){}}}};e.prototype.onMessage=function(a){return this._event("message",a)};e.prototype.onOpen=function(a){return this._event("open",a)};e.prototype.onClose=function(a){return this._event("close",a)};e.prototype.send=function(a){var b=this;return new Promise(function(h,k){var g=String(Date.now());b._processed.push(g);b._db.set(g,a).then(function(){h();var c=function(){b._db.remove(g).catch(function(){c()})};setTimeout(function(){c()},2500)},function(c){k(c)})})};e.prototype.close=function(){var a=this;return new Promise(function(b){a.readyState=2;var h=function(){if(3==a.readyState){b(!0);for(var k=f.makeIterator(a._callback.filter(function(c){return"close"==c.name})),g=k.next();!g.done;g=k.next())g.value.callback({error:Error("GameSocket was manually disconnected."),timestamp:Number(Date.now())})}else setTimeout(h,16)};h()})};e.version="1.0.1";Object.assign(e,{CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3});return e});
