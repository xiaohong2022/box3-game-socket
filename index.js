/*!
 * GameSocket.js v1.0.0
 * Copyright (c) 2023 by 小宏XeLa
 * Licensed under MIT
 */
!function(g,m){"undefined"!==typeof module?module.exports=m():(g||globalThis).GameSocket=m()}(this,function(){var g={arrayIteratorImpl:function(b){var a=0;return function(){return a<b.length?{done:!1,value:b[a++]}:{done:!0}}},arrayIterator:function(b){return{next:g.arrayIteratorImpl(b)}},makeIterator:function(b){var a="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if(a)return a.call(b);if("number"==typeof b.length)return g.arrayIterator(b)}},m=Error("GameSocket runtime requires GameStorage.");if(!GameStorage)throw m;var f=storage,p=f.getGroupStorage;if(!f||!p)throw m;f=function(b){var a=this;Object.assign(a,{readyState:0,_db:p("GAMESOCKET_DBNAME_"+b),_processed:[],_closed:!1,_callback:[]});var k=Date.now(),h=function(){a._db.list({pageSize:999999999999,cursor:1}).then(function(e){if(2==a.readyState)a.readyState=3;else{if(0==a.readyState){a.readyState=1;for(var c=g.makeIterator(a._callback.filter(function(n){return"open"==n.name})),d=c.next();!d.done;d=c.next())d.value.callback({startTimestamp:Number(k),endTimestamp:Number(Date.now())})}d=e.getCurrentPage();e=g.makeIterator(d);for(d=e.next();!d.done;d=e.next())if(c=d.value,!1===a._processed.includes(c.key)){a._processed.push(c.key);var l=g.makeIterator(a._callback.filter(function(n){return"message"==n.name}));for(d=l.next();!d.done;d=l.next())d.value.callback({data:c.value,sendTimestamp:Number(c.key),acceptTimestamp:Number(Date.now())})}setTimeout(function(){h()},16)}},function(e){a.readyState=2;var c=function(){if(3==a.readyState)for(var d=g.makeIterator(a._callback.filter(function(n){return"close"==n.name})),l=d.next();!l.done;l=d.next())l.value.callback({error:e,timestamp:Number(Date.now())});else setTimeout(c,16)};c()})};h()};f.prototype.onMessage=function(b){var a={name:"message",callback:b};this._callback.push(a);return{cancel:function(){a.name="";a.callback=function(){}}}};f.prototype.onOpen=function(b){var a={name:"open",callback:b};this._callback.push(a);return{cancel:function(){a.name="";a.callback=function(){}}}};f.prototype.onClose=function(b){var a={name:"close",callback:b};this._callback.push(a);return{cancel:function(){a.name="";a.callback=function(){}}}};f.prototype.send=function(b){var a=this;return new Promise(function(k,h){var e=String(Date.now());a._processed.push(e);a._db.set(e,b).then(function(){k();var c=function(){a._db.remove(e).catch(function(){c()})};setTimeout(function(){c()},2500)},function(c){h(c)})})};f.prototype.close=function(){var b=this;return new Promise(function(a){b.readyState=2;var k=function(){if(3==b.readyState){a(!0);for(var h=g.makeIterator(b._callback.filter(function(c){return"close"==c.name})),e=h.next();!e.done;e=h.next())e.value.callback({error:Error("GameSocket was manually disconnected."),timestamp:Number(Date.now())})}else setTimeout(k,16)};k()})};Object.assign(f,{version:"1.0.0",CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3});return f});
